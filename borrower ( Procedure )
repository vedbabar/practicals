DELIMITER $$

CREATE PROCEDURE return_book_simple(
    IN p_roll INT,
    IN p_book VARCHAR(100)
)
BEGIN
    DECLARE v_date DATE;
    DECLARE v_days INT DEFAULT 0;
    DECLARE v_fine DECIMAL(10,2) DEFAULT 0;
    DECLARE v_status CHAR(1);

    -- Get issue date and status
    SELECT dateofissue, status
    INTO v_date, v_status
    FROM borrower
    WHERE roll = p_roll AND nameofbook = p_book
    LIMIT 1;

    -- Calculate fine only if book was issued
    IF v_status = 'I' THEN
        SET v_days = DATEDIFF(CURDATE(), v_date);

        IF v_days > 30 THEN
            SET v_fine = (v_days - 30) * 50 + 15 * 5;   -- Rs 5/day (16–30), Rs 50/day (>30)
        ELSEIF v_days > 15 THEN
            SET v_fine = (v_days - 15) * 5;             -- Rs 5/day (16–30)
        END IF;

        -- Update status to Returned
        UPDATE borrower
        SET status = 'R'
        WHERE roll = p_roll AND nameofbook = p_book;

        -- Insert fine record if applicable
        IF v_fine > 0 THEN
            INSERT INTO fine (roll, date, amt)
            VALUES (p_roll, CURDATE(), v_fine);
        END IF;
    END IF;
END$$

DELIMITER ;







CREATE TABLE borrower (
  roll INT,
  name VARCHAR(100),
  dateofissue DATE,
  nameofbook VARCHAR(100),
  status CHAR(1)
);

CREATE TABLE fine (
  roll INT,
  date DATE,
  amt DECIMAL(10,2)
);

INSERT INTO borrower VALUES
(1, 'Ved', '2025-09-20', 'DBMS', 'I'),
(2, 'Ruchir', '2025-10-15', 'AI', 'I');

-- Run the procedure
CALL return_book_simple(1, 'DBMS');

-- Check results
SELECT * FROM borrower;
SELECT * FROM fine;

